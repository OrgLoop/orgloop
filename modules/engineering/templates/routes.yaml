apiVersion: orgloop/v1alpha1
kind: RouteGroup

routes:
  - name: "{{ module.name }}-pr-review"
    description: "PR review submitted — address feedback"
    when:
      source: "{{ params.github_source }}"
      events:
        - resource.changed
      filter:
        provenance.platform_event: pull_request.review_submitted
    transforms:
      - ref: my-notifications
      - ref: dedup
    then:
      actor: "{{ params.agent_actor }}"
      config:
        session_key: "orgloop:{{ params.github_source }}:pr-review"
        wake_mode: now
        deliver: true
    with:
      prompt_file: "{{ module.path }}/sops/pr-review.md"

  - name: "{{ module.name }}-pr-comment"
    description: "PR review comment — respond to inline feedback"
    when:
      source: "{{ params.github_source }}"
      events:
        - resource.changed
      filter:
        provenance.platform_event: pull_request_review_comment
    transforms:
      - ref: my-notifications
      - ref: dedup
    then:
      actor: "{{ params.agent_actor }}"
      config:
        session_key: "orgloop:{{ params.github_source }}:pr-comment"
        wake_mode: now
        deliver: true
    with:
      prompt_file: "{{ module.path }}/sops/pr-review.md"

  - name: "{{ module.name }}-ci-failure"
    description: "CI failure — diagnose and fix"
    when:
      source: "{{ params.github_source }}"
      events:
        - resource.changed
      filter:
        provenance.platform_event: workflow_run.completed
    transforms:
      - ref: my-notifications
    then:
      actor: "{{ params.agent_actor }}"
      config:
        session_key: "orgloop:{{ params.github_source }}:ci-failure"
        wake_mode: now
    with:
      prompt_file: "{{ module.path }}/sops/ci-failure.md"

  - name: "{{ module.name }}-linear-triage"
    description: "Linear issue updates — triage and act"
    when:
      source: "{{ params.linear_source }}"
      events:
        - resource.changed
    transforms:
      - ref: dedup
    then:
      actor: "{{ params.agent_actor }}"
      config:
        session_key: "orgloop:{{ params.linear_source }}:activity"
        wake_mode: now
        deliver: true
    with:
      prompt_file: "{{ module.path }}/sops/linear-ticket.md"

  - name: "{{ module.name }}-claude-code-supervisor"
    description: "Claude Code session ended — review and decide next action"
    when:
      source: "{{ params.claude_code_source }}"
      events:
        - actor.stopped
    then:
      actor: "{{ params.agent_actor }}"
      config:
        session_key: "orgloop:{{ params.claude_code_source }}:supervisor"
        wake_mode: now
    with:
      prompt_file: "{{ module.path }}/sops/claude-code-supervisor.md"
